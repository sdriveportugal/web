<!DOCTYPE html>
<html>
<head>
    <title>Quiz App - Google Sheets Version</title>
    <style>
    
    </style>
</head>
<body>
    <div id="timer">Time Remaining: 30:00</div>
    <div id="question-container"></div>
    <button id="prev-button" class="hidden">&lt;</button>
    <button id="submit-button">Submit Answer</button>
    <button id="next-button" class="hidden">></button>
    <button id="restart-button" class="hidden">Restart Quiz</button>

<script type="module">
    let currentQuestionIndex = 0;
    let quizData = [];
    let selectedAnswer = null;
    let answered = false;
    let correctAnswers = 0;
    let wrongAnswers = 0;
    let userAnswers = [];
    let answerStatus = [];
    let quizFinished = false;
    let timerInterval;
    let timeRemaining = 30 * 60;

    // Fetch questions from Google Sheet
    async function fetchQuestions() {
        try {
            const response = await fetch('https://opensheet.elk.sh/1w6RQT9mK13IfcD5pZyQoRw7eMGkgfDi65SuAVGYHrQU/main');
            const allQuestions = await response.json();
            
            return allQuestions.map(question => ({
                ID: question.ID,
                question: question.question,
                optionA: question.optionA?.replace(/;$/, ''),
                optionB: question.optionB?.replace(/;$/, ''),
                optionC: question.optionC?.replace(/;$/, ''),
                Answer: question.Answer,
                Explanation: question.Explanation,
                image: question.image
            }));
        } catch (error) {
            console.error('Error fetching questions:', error);
            return null;
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function showQuestion(index) {
        const question = quizData[index];
        const questionContainer = document.getElementById('question-container');

        questionContainer.innerHTML = '';
        selectedAnswer = null;
        answered = false;

        const optionC = question.optionC ? `
            <li id="optionC">
                <span class="option-label">C.</span>
                <span class="option-text">${question.optionC}</span>
            </li>` : '';

        questionContainer.innerHTML = `
            ${question.image ? `<img src="${question.image}" alt="Question Image" />` : ''}
            <h3>Question ${index + 1} of 30</h3>
            <p>${question.question}</p>
            <ul>
                <li id="optionA">
                    <span class="option-label">A.</span>
                    <span class="option-text">${question.optionA}</span>
                </li>
                <li id="optionB">
                    <span class="option-label">B.</span>
                    <span class="option-text">${question.optionB}</span>
                </li>
                ${optionC}
            </ul>
            <p id="answer" class="hidden"><strong>Correct Answer:</strong> ${question.Answer}</p>
            <p id="explanation" class="hidden"><strong>Explanation:</strong> ${question.Explanation || 'No explanation available'} (ID: ${question.ID})</p>
        `;

        document.getElementById('optionA').addEventListener('click', () => selectAnswer('A', 'optionA'));
        document.getElementById('optionB').addEventListener('click', () => selectAnswer('B', 'optionB'));

        if (question.optionC) {
            document.getElementById('optionC').addEventListener('click', () => selectAnswer('C', 'optionC'));
        }

        if (userAnswers[index]) {
            document.getElementById(`option${userAnswers[index]}`).classList.add('selected');
            const answerElement = document.getElementById('answer');
            const explanationElement = document.getElementById('explanation');
            answerElement.classList.remove('hidden');
            explanationElement.classList.remove('hidden');

            if (answerStatus[index] === 'correct') {
                document.getElementById(`option${userAnswers[index]}`).style.backgroundColor = 'lightgreen';
            } else if (answerStatus[index] === 'incorrect') {
                document.getElementById(`option${userAnswers[index]}`).style.backgroundColor = 'lightcoral';
                document.getElementById(`option${question.Answer}`).style.backgroundColor = 'lightgreen';
            }

            document.getElementById('submit-button').classList.add('hidden');
            document.getElementById('next-button').classList.remove('hidden');
        } else {
            document.getElementById('submit-button').classList.remove('hidden');
            document.getElementById('next-button').classList.add('hidden');
        }

        document.getElementById('prev-button').classList.toggle('hidden', currentQuestionIndex === 0);
        document.getElementById('next-button').textContent = index === 29 ? 'End Test' : '>';
        document.getElementById('restart-button').classList.toggle('hidden', !quizFinished);
    }

    function selectAnswer(answer, elementId) {
        if (quizFinished) return;
        if (!answered) {
            selectedAnswer = answer;
            userAnswers[currentQuestionIndex] = answer;
            document.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
            document.getElementById(elementId).classList.add('selected');
        }
    }

    function checkAnswer() {
        if (!selectedAnswer) {
            alert('Please select an answer before submitting.');
            return;
        }

        const question = quizData[currentQuestionIndex];
        const answerElement = document.getElementById('answer');
        const explanationElement = document.getElementById('explanation');

        answerElement.classList.remove('hidden');
        explanationElement.classList.remove('hidden');
        answered = true;

        if (selectedAnswer === question.Answer) {
            correctAnswers++;
            answerStatus[currentQuestionIndex] = 'correct';
            document.getElementById(`option${selectedAnswer}`).style.backgroundColor = 'lightgreen';
        } else {
            wrongAnswers++;
            answerStatus[currentQuestionIndex] = 'incorrect';
            document.getElementById(`option${selectedAnswer}`).style.backgroundColor = 'lightcoral';
            document.getElementById(`option${question.Answer}`).style.backgroundColor = 'lightgreen';
        }

        document.getElementById('submit-button').classList.add('hidden');
        document.getElementById('next-button').classList.remove('hidden');
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                showResults();
            } else {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('timer').innerText = `Time Remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }

    function showResults() {
        quizFinished = true;
        clearInterval(timerInterval);
        const questionContainer = document.getElementById('question-container');
        questionContainer.innerHTML = `
            <h3>Test Completed!</h3>
            <p>Correct Answers: ${correctAnswers}</p>
            <p>Wrong Answers: ${wrongAnswers}</p>
            <p id="resultMessage" style="font-size: 24px; padding: 20px; border-radius: 8px; color: white; text-align: center;">
                ${correctAnswers > 26 ? '<span style="background-color: green;">Congratulations! You passed! ðŸŽ‰</span>' : '<span style="background-color: red;">Try again! ðŸ˜¢</span>'}
            </p>
        `;
        document.getElementById('restart-button').classList.remove('hidden');
    }

    document.getElementById('submit-button').addEventListener('click', checkAnswer);
    document.getElementById('next-button').addEventListener('click', () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < 30) showQuestion(currentQuestionIndex);
        else showResults();
    });
    document.getElementById('prev-button').addEventListener('click', () => {
        if (currentQuestionIndex > 0) showQuestion(--currentQuestionIndex);
    });
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    // Initialize the quiz
    async function initializeQuiz() {
        const allQuestions = await fetchQuestions();
        if (allQuestions) {
            quizData = shuffleArray(allQuestions).slice(0, 30);
            showQuestion(currentQuestionIndex);
            startTimer();
        } else {
            alert('Failed to load questions. Please try again later.');
        }
    }

    initializeQuiz();
</script>
</body>
</html>